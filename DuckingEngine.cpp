#include "stdafx.h"
#include "DuckingEngine.h"

// #todo- 이거 꼭 지워야함
#pragma comment(lib, "d3d12.lib")
#include <d3d12.h>
#pragma comment(lib, "dxgi.lib")
#include <dxgi1_6.h>
#pragma comment(lib, "d3dcompiler.lib")
#include <d3dcompiler.h>
#include "d3dx12.h"

#pragma region System Modules
#include "InputModule.h"
#include "RenderModule.h"
#include "SceneRenderer.h"
#pragma endregion

#pragma region Engine Core Module
#include "ResourceManager.h"
#include "TextureManager.h"
#include "SceneObjectManager.h"

#include "GameModule.h"
#pragma endregion

#include "EditorDebugDrawManager.h"

#include "Camera.h"
#include "SceneObject.h"
#include "SkinnedMeshComponent.h"
#include "Material.h"

DuckingEngine* DuckingEngine::_duckingEngine;
RenderModule* DuckingEngine::_renderModule = nullptr;
SceneRenderer* DuckingEngine::_sceneRenderer = nullptr;
TextureManager* DuckingEngine::_textureManager = nullptr;
ResourceManager* DuckingEngine::_resourceManager = nullptr;
SceneObjectManager* DuckingEngine::_sceneObjectManager = nullptr;
GameModule* DuckingEngine::_gameModule = nullptr;

bool DuckingEngine::Initialize(HWND hwnd, int width, int height)
{
#pragma region Input Modules
	if (InputModule::InitializePCController() == false) return false;
	if (InputModule::InitializeXBOXController(0) == false) return false;
#pragma endregion

	// SceneRenderer의 Initialize에 RenderModule이 필요하기때문에 먼저 생성
	// #todo- RenderModule은 SceneRenderer에서만 쓰기로 할 수 있다면.. SceneRenderer의 생성자에서 RenderModule을 initialize하는 방향이 좋아보임
	// >> DuckingEngine::getInstance().getRenderModule()을 통해서 RenderModule에 접근하는 코드가 너무 많음
#pragma region RenderModule
	_renderModule = dk_new RenderModule;
	if (_renderModule->initialize(hwnd, width, height) == false) return false;
#pragma endregion

#pragma region MainCamera
	Camera::gMainCamera = dk_new Camera(90.0f, width, height);
	Transform cameraTransform(float3(0, 1, -1), float3::Zero, float3::Identity);
	Camera::gMainCamera->SetWorldTransform(cameraTransform);
#pragma endregion

	// Camera 정보가 필요하기 때문에 이 곳에서 SceneConstantBuffer를 생성합니다.
	// #todo- 어차피 매프레임 업데이트하기 때문에 굳이 이렇게 할 필요는 없음.. PreRender직후 바로 업데이트하기 때문
#pragma region SceneRenderer
	_sceneRenderer = dk_new SceneRenderer;
	if (_sceneRenderer->initialize() == false) return false;
#pragma endregion

#pragma region Core Module
	_textureManager = dk_new TextureManager;
	if (_textureManager->initialize() == false) return false;
	_resourceManager = dk_new ResourceManager;
	_sceneObjectManager = dk_new SceneObjectManager;
#pragma endregion

#pragma region Editor Modules
#if defined(_DK_DEBUG_)
	// 현재 Editor는 사용하지 않아 아무것도 하지 않습니다.
	EditorDebugDrawManager::getSingleton().initialize();
#endif
#pragma endregion

#pragma region Game Module
	_gameModule = dk_new GameModule;
	if (_gameModule->Initialize() == false) return false;
#pragma endregion

	return true;
}

void DuckingEngine::Update(float deltaTime) const
{
	InputModule::Update();

	Camera::gMainCamera->Update();

	_sceneObjectManager->update(deltaTime);
}

void DuckingEngine::Render() const
{
	_sceneRenderer->prepareShaderData();

	_sceneRenderer->preRender();
	_sceneRenderer->updateRender();
	_sceneRenderer->EndRender();
}